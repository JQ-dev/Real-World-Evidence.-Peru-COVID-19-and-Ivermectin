

/*! *********************************************
  *                                             *
  *   Audio Player RPP                          *
  *   by Moises Torres | http://codart.pe       *
  *   01/2018                                   *
  *                                             *
  ********************************************* */


; (function (win, id, factory) {
  "use strict";
  if (typeof (module) !== 'undefined' && module.exports) {
    module.exports = factory(id, win)
  } else if (typeof (define) === 'function' && define.amd) {
    define(function () {
      return factory(id, win)
    })
  } else {
    if (!window.AudioPlayer) {
      win[id] = factory(id, win)
    }
  }
})(window, 'AudioPlayer', function (id, window) {
  "use strict";
  var extend = function (origin, add) {
    if (!add || typeof add !== 'object') return origin;
    var keys = Object.keys(add);
    var i = keys.length;
    while (i--) {
      origin[keys[i]] = add[keys[i]]
    }
    return origin
  };

  function EventDispatch() { }
  EventDispatch.prototype = {
    constructor: EventDispatch,
    on: function (evt, fn, ctx) {
      this.subscribe(evt, fn, ctx, false)
    },
    one: function (evt, fn, ctx) {
      this.subscribe(evt, fn, ctx, true)
    },
    off: function (evt, fn) {
      if (this._listeners === undefined) return;
      var listerners = this._listeners,
        _fn;
      for (var i = 0, len = listerners[evt].length; i < len; i++) {
        _fn = listerners[evt][i].fn;
        if (_fn === fn) {
          listerners[evt].splice(i, 1);
          break
        }
      }
    },
    subscribe: function (evt, fn, ctx, once) {
      if (this._listeners === undefined) {
        this._listeners = {}
      }
      this._listeners[evt] = this._listeners[evt] || [];
      this._listeners[evt].push({
        fn: fn,
        ctx: ctx,
        once: (once || false)
      })
    },
    trigger: function (evt) {
      if (this._listeners && this._listeners.hasOwnProperty(evt)) {
        var args = Array.prototype.slice.call(arguments, 1);
        var listerners = this._listeners,
          _list = [],
          _listerner;
        while (listerners[evt].length > 0) {
          _listerner = listerners[evt].shift();
          if (typeof _listerner.fn === 'function') {
            _listerner.fn.apply(_listerner.ctx, args)
          }
          if (!_listerner.once) {
            _list.push(_listerner)
          }
        }
        listerners[evt] = _list
      }
    }
  };

  var AudioPlayer = function (config) {
    this.version = "1.17052018",
    this.gtag = 'UA-36526254-1';
    this.audio = null;
    this.playing = false;
    this.started = false;
    this.vol = 1;
    this.duration = 0;
    this.position = 0;
    this.load_percent = 0;
    this.seekable = false;
    this.track = {
      play: false,
      do25: false,
      do50: false,
      do75: false
    };
    this.config = config;
    this.init(config)
  };

  AudioPlayer.prototype = {
    constructor: AudioPlayer,
    init: function (config) {
      var script = document.getElementById('ca-audio');
      if (!script) throw 'no existe el script id="ca-audio"';
      config.baseUrl = script.src.split('/js/')[0];
      this.container = document.getElementById(config.id);
      var audio = document.createElement('audio');
      this.container.appendChild(audio);
      this.audio = audio;
      this.draw(config);
      this.bindEvents();

      if (config.ads) {
        this.vast = new Vast(config, this);
      }else {
        this.load(config.media);
      }
    },
    isMobile: navigator.userAgent.match(/Android/i)
      || navigator.userAgent.match(/webOS/i)
      || navigator.userAgent.match(/iPhone/i)
      || navigator.userAgent.match(/iPad/i)
      || navigator.userAgent.match(/iPod/i)
      || navigator.userAgent.match(/BlackBerry/i)
      || navigator.userAgent.match(/Windows Phone/i)
      || false,
    destroy: function () {
      if (this.playing) {
        this.trigger('pause');
      }
      this.unbindEvents();
      delete this.audio;
      this.container.innerHTML = null;
    },
    setupEventListeners: function () {
      this.listeners = {
        loadstart: this.onLoadStart.bind(this),
        canplay: this.onCanplay.bind(this),
        loadedmetadata: this.onLoadMetadata.bind(this),
        play: this.onPlay.bind(this),
        timeupdate: this.onTimeUpdate.bind(this),
        pause: this.onPause.bind(this),
        ended: this.onEnded.bind(this),
        error: this.onError.bind(this),
        seeking: this.onSeeking.bind(this),
        seeked: this.onSeeked.bind(this),
        waiting: this.onWaiting.bind(this),
      }
    },
    bindEvents: function () {
      if (this.listeners === undefined) {
        this.setupEventListeners()
      }
      this.audio.addEventListener('loadstart', this.listeners.loadstart, false);
      this.audio.addEventListener('canplay', this.listeners.canplay, false);
      this.audio.addEventListener('loadedmetadata', this.listeners.loadedmetadata, false);
      this.audio.addEventListener('play', this.listeners.play, false);
      this.audio.addEventListener('timeupdate', this.listeners.timeupdate, false);
      this.audio.addEventListener('pause', this.listeners.pause, false);
      this.audio.addEventListener('ended', this.listeners.ended, false);
      this.audio.addEventListener('error', this.listeners.error, false);
      this.audio.addEventListener('seeking', this.listeners.seeking, false);
      this.audio.addEventListener('seeked', this.listeners.seeked, false);
      this.audio.addEventListener('waiting', this.listeners.waiting, false);
    },
    unbindEvents: function () {
      this.audio.removeEventListener('loadstart', this.listeners.loadstart);
      this.audio.removeEventListener('canplay', this.listeners.canplay);
      this.audio.removeEventListener('loadedmetadata', this.listeners.loadedmetadata);
      this.audio.removeEventListener('play', this.listeners.play);
      this.audio.removeEventListener('timeupdate', this.listeners.timeupdate);
      this.audio.removeEventListener('pause', this.listeners.pause);
      this.audio.removeEventListener('ended', this.listeners.ended);
      this.audio.removeEventListener('error', this.listeners.error);
      this.audio.removeEventListener('seeking', this.listeners.seeking);
      this.audio.removeEventListener('seeked', this.listeners.seeked);
      this.audio.removeEventListener('waiting', this.listeners.waiting);
    },
    onLoadStart: function () {
      this.trigger('loadstart')
    },
    onCanplay: function () {
      this.seekable = this.audio.seekable && this.audio.seekable.length > 0;
      if (this.seekable) {
        this.timer = setInterval(this.onProgress.bind(this), 500)
      }
      /*
      var name = this.list[this.index].name || '',
          time = this.list[this.index].time || '';
      this.trigger('canplay', time, name, this.list[this.index])
      */
    },
    onLoadMetadata: function () {
      if (this.audio.duration === Infinity) {
        find('.ca-control-stream', this.ui.wrap).style.display = 'block';
        find('.ca-control-podcast', this.ui.wrap).style.display = 'none';
        this.audio.removeEventListener('timeupdate', this.listeners.timeupdate);
      } else {
        this.ui.LabelTimeTotal.innerText = formatSec(this.audio.duration);
      }
      this.ui.wrap.classList.remove('ca-loading');
      this.trigger('loadedmetadata');
    },
    onPlay: function () {
      this.playing = true;
      this.trigger('play');

      this.ui.wrap.classList.add('ca-playing');
      if (!this.started) {
        this.started = true;
        this.ui.wrap.classList.add('ca-started');
      }
      if (!this.track.play) {
        this.track.play = true;
        this.handleTrack('play');
      }

      if(typeof _radioPlayer === 'object' && _radioPlayer.playing) _radioPlayer.playPause();

    },
    onTimeUpdate: function () {
      if (this.vast && this.vast.status === 2) return;
      if (this.audio && this.playing) {
        var formatTime, playedPercent;
        try {
          this.position = this.audio.currentTime;
          this.duration = this.audio.duration === Infinity ? null : this.audio.duration;
          formatTime = formatSec(this.position);
          playedPercent = ((this.position / this.duration) * 100).toFixed(6);
        } catch (e) { }
        this.trigger('timeupdate', playedPercent, this.position, this.duration);

        this.ui.sliderMove.style.width = playedPercent + '%';
        this.ui.labelTime.innerText = formatSec(this.audio.currentTime);

        if (!this.track.do25) {
          var do25 = Math.round(25 * this.audio.duration) / 100;
          if (this.audio.currentTime > do25) {
            this.handleTrack('25p');
            this.track.do25 = true;
          }
        }

        if (!this.track.do50) {
          var do50 = Math.round(50 * this.audio.duration) / 100;
          if (this.audio.currentTime > do50) {
            this.handleTrack('50p');
            this.track.do50 = true;
          }
        }

        if (!this.track.do75) {
          var do75 = Math.round(75 * this.audio.duration) / 100;
          if (this.audio.currentTime > do75) {
            this.handleTrack('75p');
            this.track.do75 = true;
          }
        }

      }
    },
    onPause: function () {
      this.playing = false;
      this.trigger('pause');

      this.ui.wrap.classList.remove('ca-playing');
    },
    onEnded: function () {
      this.playing = false;
      this.trigger('ended');

      this.handleTrack('ended');

      this.ui.wrap.classList.remove('ca-playing');
      this.track = {
        play: false,
        do25: false,
        do50: false,
        do75: false,
      }
    },
    onError: function (e) {
      this.ui.wrap.classList.add('ca-error');
      this.trigger('error', e)
    },
    onSeeking: function () {
      this.trigger('seeking');

      this.ui.wrap.classList.add('ca-loading');
    },
    onSeeked: function () {
      this.trigger('seeked');

      this.ui.wrap.classList.remove('ca-loading');
    },
    onProgress: function () {
      if (this.audio && this.audio.buffered !== null && this.audio.buffered.length) {
        this.duration = this.audio.duration === Infinity ? null : this.audio.duration;
        this.load_percent = ((this.audio.buffered.end(this.audio.buffered.length - 1) / this.duration) * 100).toFixed(4);
        if (isNaN(this.load_percent)) {
          this.load_percent = 0
        }
        if (parseFloat(this.load_percent) >= 100) {
          this.clearLoadProgress()
        }
        this.trigger('progress', this.load_percent)
      }
    },
    onWaiting: function () {
      this.trigger('waiting')
    },
    clearLoadProgress: function () {
      if (this.timer !== undefined) {
        clearInterval(this.timer);
        delete this.timer
      }
    },
    reset: function () {
      this.clearLoadProgress();
      this.seekable = false;
      this.duration = 0;
      this.position = 0;
      this.load_percent = 0
    },
    load: function (url, ads) {
      this.audio.src = url;
      this.audio.load();
    },
    play: function () {
      if (!this.seekable) {
        this.timer = setInterval(this.onProgress.bind(this), 500)
      }
      if (this.vast && this.vast.status === 0) {
        this.vast.getContent();
        return;
      }
      this.setTitle(this.config.title);
      this.audio.play()
    },
    pause: function () {
      this.setTitle(this.config.title, false, true);
      this.audio.pause()
    },
    playPause: function () {

      this[this.playing ? 'pause' : 'play']()
    },
    volume: function (vol) {
      if (vol && vol > 0 && vol < 1) {
        this.audio.volume = vol
      } else {
        return this.audio.volume
      }
    },
    progress: function (sec) {
      if (sec) {
        this.audio.pause();
        this.audio.currentTime = sec;
        this.audio.play()
      } else {
        return this.audio.currentTime
      }
    },
    draw: function (config) {
      var iframe = document.createElement("iframe");
      var iframeId = "iframe" + config.id;

      iframe.scrolling = "no";
      iframe.setAttribute("id", iframeId);
      iframe.setAttribute("width", "100%");
      iframe.setAttribute("height", 102);
      iframe.frameBorder = 0;

      this.container.appendChild(iframe);
      iframe = document.getElementById(iframeId); // TODO ¿?
      this.iframe = iframe;

      var whatsapp = this.isMobile ? '<li class="ca-sharewa">' +
        '<a href="whatsapp://send?text=' + config.title + ' ' + config.url + '" target="_blank" class="ca-circle ca-lnkwa" data-type="whatsapp">'+
          '<span class="ca-ico"></span>' +
        '</a>' +
      '</li>' : '';
      var iFrWin = iframe.contentWindow;// || iframe.contentDocument;
      iFrWin.document.write('<div class="ca-wrap xxca-played ca-loading xxca-modal xxxca-error xxxca-ads" style="opacity:0">' +
        '<div class="ca-circular indeterminate">' +
          '<svg class="ca-oval" viewBox="0 0 60 60">' +
            '<circle class="ca-path" cx="30" cy="30" r="25"></circle>' +
          '</svg>' +
        '</div>' +
        '<a class="ca-playpause ca-circle">' +
        '</a>' +
        '<div class="ca-content">' +
          '<div class="ca-title">' +
            config.title +
          '</div>' +
          '<div class="ca-control ca-control-podcast">' +
            '<div class="ca-currenttime">00:00</div>' +
            '<div class="ca-ads-label">Publicidad</div>' +
            '<div class="ca-totaltime">00:00</div>' +
            '<div class="ca-slider">' +
              '<div class="ca-sliderarea">' +
                '<div class="ca-slidertotal">' +
                  '<div class="ca-slidermove"></div>' +
                '</div>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="ca-control ca-control-stream">' +
            '<span class="ca-control-live">En vivo</span>' +
          '</div>' +
        '</div>' +
        '<div class="ca-sharefront">' +
          '<span class="ca-copymsg">Copiado al portapapeles</span>' +
          '<a class="ca-modalclose">' +
            '<span></span>' +
          '</a>' +
          '<ul>' +
            '<li class="ca-sharefb">' +
              '<a href="https://www.facebook.com/sharer/sharer.php?u=' + config.url + '&t=' + config.title + '" target="_blank" class="ca-circle ca-lnkfb" data-type="facebook">' +
                '<span class="ca-ico"></span>' +
                '<span class="ca-label">Compartir</span>' +
              '</a>' +
            '</li>' +
            '<li class="ca-sharetw">' +
              '<a href="https://twitter.com/intent/tweet?original_referer=' + config.url + '&text=' + config.title + '&url=' + config.url + '&via=RPPNoticias" target="_blank" class="ca-circle ca-lnktw" data-type="twitter">' +
                '<span class="ca-ico"></span>' +
              '</a>' +
            '</li>' +
            whatsapp +
            '<li class="ca-sharere">' +
              '<a href="' + config.url + '" target="_blank" class="ca-circle ca-lnkre" data-type="read">' +
                '<span class="ca-ico"></span>' +
                '<span class="ca-label">Leer</span>' +
              '</a>' +
            '</li>' +
            '<li class="ca-shareeb">' +
              '<a class="ca-circle ca-lnkeb">' +
                '<span class="ca-ico"></span>' +
                '<span class="ca-label">Embed</span>' +
              '</a>' +
            '</li>' +
          '</ul>' +
        '</div>' +
        '<div class="ca-errorfront">' +
          '<span>Recurso no disponible</span>' +
        '</div>' +
        '<div>' +
          '<a class="ca-volumeico"></a>' +
          '<div class="ca-volume">' +
            '<div class="ca-volumearea"></div>' +
            '<div class="ca-volumerange"></div>' +
          '</div>' +
        '</div>' +
        '<div class="ca-tools">' +
          '<a class="ca-icomore"><span class="ca-punto"></span><span class="ca-punto"></span><span class="ca-punto"></span></a>' +
          '<a href="//rpp.pe" target="_blank" class="ca-icobrand">' +
            '<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGlkPSJDYXBhXzEiIHZpZXdCb3g9IjAgMCA0NSA0NSI+PHN0eWxlPi5zdDB7ZmlsbDojZjdlMDAwfS5zdDF7ZmlsbC1ydWxlOmV2ZW5vZGQ7Y2xpcC1ydWxlOmV2ZW5vZGR9PC9zdHlsZT48cGF0aCBjbGFzcz0ic3QwIiBkPSJNMCAyMi41QzAgMTAuMSAxMC4xLjEgMjIuNS4xUzQ1IDEwLjEgNDUgMjIuNWMwIDEyLjQtMTAuMSAyMi40LTIyLjUgMjIuNFMwIDM0LjkgMCAyMi41Ii8+PHBhdGggZD0iTTExLjYgMjYuNmMyLjQtLjUgNC4yLTIuNyA0LjItNS4zIDAtMy0yLjQtNS40LTUuNC01LjQtMyAwLTUuNCAyLjQtNS40IDUuNHY4LjFoMi4ydi0zLjdjMi4yIDIuMyA1LjMgMy43IDguNyAzLjd2LTEuOWMtMS42IDAtMy0uMy00LjMtLjltLTQuNC01LjJjMC0xLjggMS41LTMuMyAzLjMtMy4zIDEuOCAwIDMuMyAxLjUgMy4zIDMuMyAwIDEuOC0xLjUgMy4zLTMuMyAzLjMtMS44LS4xLTMuMy0xLjUtMy4zLTMuMyIvPjxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0yMi45IDE2Yy0zIDAtNS40IDIuNC01LjQgNS40djguMWgyLjJ2LTMuOGMuOS43IDIgMS4xIDMuMiAxLjEgMyAwIDUuNC0yLjQgNS40LTUuNCAwLTMtMi40LTUuNC01LjQtNS40bTAgOC42Yy0xLjggMC0zLjItMS40LTMuMi0zLjJzMS40LTMuMiAzLjItMy4yYzEuOCAwIDMuMiAxLjQgMy4yIDMuMnMtMS40IDMuMi0zLjIgMy4yTTM0LjYgMTZjLTMgMC01LjQgMi40LTUuNCA1LjR2OC4xaDIuMnYtMy44Yy45LjcgMiAxLjEgMy4yIDEuMSAzIDAgNS40LTIuNCA1LjQtNS40IDAtMy0yLjQtNS40LTUuNC01LjRtMCA4LjZjLTEuOCAwLTMuMi0xLjQtMy4yLTMuMiAwLTEuOCAxLjQtMy4yIDMuMi0zLjIgMS44IDAgMy4yIDEuNCAzLjIgMy4yIDAgMS43LTEuNSAzLjItMy4yIDMuMiIvPjwvc3ZnPg==" alt="RPP Player">' +
          '</a>' +
        '</div>' +
      '</div>' +
      '<script>' +
        'window.dataLayer = window.dataLayer || [];' +
        'function gtag(){dataLayer.push(arguments);}' +
        'gtag("js", new Date());' +
        'gtag("config", "' + this.gtag + '");' +
        'window.addEventListener("message", function(event) {' +
          'var data = event.data.split("|");' +
          'gtag("event", data[0], {' +
            '"event_category": "ca-audio",' +
            '"event_label": data[1]' +
          '});' +
        '});' +
      '</script>');
      iFrWin.document.close();

      // gtag.js
      var gtagJs = document.createElement("script");
      gtagJs.type = "text/javascript";
      gtagJs.async = true;
      gtagJs.src = 'https://www.googletagmanager.com/gtag/js?id=' + this.gtag;
      iframe.contentDocument.head.appendChild(gtagJs);

      // css
      var link = document.createElement("link");
      link.href = this.config.baseUrl + '/css/ca-audio.css?v=' + this.version;
      link.rel = "stylesheet";
      iframe.contentDocument.head.appendChild(link);

      var iFrDoc = iframe.contentDocument;
      //iFrDoc.addEventListener

      this.ui = {};

      // wrap
      this.ui.wrap = find('.ca-wrap', iFrDoc);

      // playpause

      this.ui.playPause = find('.ca-playpause', iFrDoc);
      this.ui.playPause.addEventListener('click', this.playPause.bind(this), false);

      // slider
      this.ui.sliderMove = find('.ca-slidermove', iFrDoc);

      //title
      this.ui.title = find('.ca-title', iFrDoc)

      // more modal
      this.ui.btnMore = find('.ca-icomore', iFrDoc);
      this.ui.btnMore.addEventListener('click', this.handleMore.bind(this), false);
      this.ui.btnMoreClose = find('.ca-modalclose', iFrDoc);
      this.ui.btnMoreClose.addEventListener('click', this.handleMore.bind(this), false);

      // copy
      this.ui.btnCopy = find('.ca-lnkeb', iFrDoc);
      this.ui.btnCopy.addEventListener('click', this.handleCopy.bind(this), false);

      // seek
      this.ui.sliderArea = find('.ca-sliderarea', iFrDoc);
      this.ui.sliderArea.addEventListener('click', this.handleSeek.bind(this), false);

      // labelAdsSkip
      this.ui.adsLabelSkip = find('.ca-ads-label', iFrDoc);

      // label progress
      this.ui.labelTime = find('.ca-currenttime', iFrDoc);
      this.ui.LabelTimeTotal = find('.ca-totaltime', iFrDoc);
      if (this.isMobile){
        find('.ca-lnkwa', iFrDoc).addEventListener('click', this.handleClick.bind(this), false);
      }
      find('.ca-lnkfb', iFrDoc).addEventListener('click', this.handleClick.bind(this), false);
      find('.ca-lnktw', iFrDoc).addEventListener('click', this.handleClick.bind(this), false);
      find('.ca-lnkre', iFrDoc).addEventListener('click', this.handleClick.bind(this), false);
    },
    setTitle: function(title, fnClick, hideMarquee) {
      var child = this.isMobile && !hideMarquee ? ('<marquee><span>' + title + '</span></marquee>') : ('<span>' + title + '</span>');
      var link;
      if (fnClick) {
        link = document.createElement("a");
        link.innerHTML = child;
        link.onclick = fnClick;
      }
      this.ui.title.innerHTML = null;
      if (link){
        this.ui.title.appendChild(link);
      } else {
        this.ui.title.innerHTML = child;
      }
    },
    handleClick: function(event) {
      var href = false;
      var size = {
        width: 560,
        height: 450
      };

      if (event.target.dataset.type === "facebook") {
        event.preventDefault();
        href = 'https://www.facebook.com/sharer/sharer.php?u=' + this.config.url + '&t=' + this.config.title;
      } else if (event.target.dataset.type === "twitter") {
        href = 'https://twitter.com/intent/tweet?original_referer=' + this.config.url + '&text=' + this.config.title + '&url=' + this.config.url + '&via=RPPNoticias';
      }
      if (href) {
        event.preventDefault();
        window.open(href, 'win' + parseInt(Math.random()*10000), 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width='+ size.width +',height='+ size.height +',left=' + ((screen.width / 2) - (size.width / 2)) + ',top=' + ((screen.height / 2) - (size.height / 2)));
      }

      this.handleTrack('share-' + event.target.dataset.type);
    },
    handleMore: function (event) {
      event.preventDefault();
      if (this.ui.wrap.classList.contains('ca-modal')) {
        this.ui.wrap.classList.remove('ca-modal');
      } else {
        this.handleTrack('share-open');
        this.ui.wrap.classList.add('ca-modal');
      }
    },
    handleCopy: function (event) {
      event.preventDefault();
      this.handleTrack('share-embed');
      clearTimeout(this.timerCopy);
      var aux = document.createElement("textarea");
      var ads = this.config.ads ? ',\n  ads: "' + this.config.ads + '"' : '';
      aux.value = '<script src="' + this.config.baseUrl + '/js/ca-audio.js?v=' + this.version + '" id="ca-audio"></script>\n' +
        '<div id="' + this.config.id + '"></div>\n' +
        '<script>\n' +
          'var ap' + parseInt(Math.random()*1000) + ' = new AudioPlayer({\n' +
          '  id: "' + this.config.id + '",\n' +
          '  media: "' + this.config.media + '",\n' +
          '  title: "' + this.config.title + '",\n' +
          '  url: "' + this.config.url + '"' + ads + '\n' +
          '});\n' +
        '</script>';
      document.body.appendChild(aux);
      aux.select();
      document.execCommand("copy");
      document.body.removeChild(aux);

      this.ui.wrap.classList.add('ca-copied');
      this.timerCopy = setTimeout(function() {
        this.ui.wrap.classList.remove('ca-copied');
      }.bind(this),3000);

    },
    handleSeek: function (event) {
      var pos = (event.offsetX * this.audio.duration) / this.ui.sliderArea.offsetWidth;
      this.progress(pos);
      //this.audio.currentTime = pos;

      var playedPercent = ((pos / this.duration) * 100).toFixed(6);
      this.ui.sliderMove.style.width = playedPercent + '%';
    },
    handleTrack: function (label) {
      if (this.vast && (this.vast.status === 2 || (this.vast.status === 1 && label === 'play'))) return;
      this.iframe.contentWindow.postMessage(label + '|' + this.config.url, "*");
    }
  };

  function find(str, doc) {
    var _document = doc || document;
    var result = _document.querySelector(str, doc);
    return result;
  };
  function findAll(str, doc) {
    var _document = doc || document;
    var result = _document.querySelectorAll(str, doc);
    return result;
  };

  function formatSec(second) {
    var _min, _sec;
    _min = parseInt(second / 60);
    _sec = parseInt(second % 60);
    return (_min >= 10 ? _min : '0' + _min) + ':' + (_sec >= 10 ? _sec : '0' + _sec)
  };
  if ('__proto__' in {}) {
    AudioPlayer.prototype.__proto__ = EventDispatch.prototype
  } else {
    extend(AudioPlayer.prototype, EventDispatch.prototype)
  };

  // vast
  var Vast = function (config, player) {
    this.config = config;
    this.player = player;
    this.status = 0; //0:init, 1:get XML, 2:playing 3:ended listen, 4:error:
    this.init()
  };

  Vast.prototype = {
    constructor: Vast,
    init: function() {
      var js = document.createElement("script");
      js.src = this.config.baseUrl + '/js/vast-client.js';
      this.player.container.appendChild(js);
      var timer = setInterval(function() {
        if (typeof DMVAST === 'object') {
          clearInterval(timer);
          this.getXML();
        }
      }.bind(this),100)
    },
    getXML: function() {
      var vast = DMVAST;
      var self = this;
      vast.client.get(self.config.ads, function(response) {
        if (response) {
          for (var adIdx = 0; adIdx < response.ads.length; adIdx++) {
            var ad = response.ads[adIdx];
            for (var creaIdx = 0; creaIdx < ad.creatives.length; creaIdx++) {
              var linearCreative = ad.creatives[creaIdx];
              if (linearCreative.type !== "linear") continue;

              if (linearCreative.mediaFiles.length) {
                self.status = 1;

                self.xml = {
                  ad: ad,
                  //linearCreative: linearCreative,
                  //media: self.createSourceObjects(linearCreative.mediaFiles)[0].src
                };
                var sources = self.createSourceObjects(linearCreative.mediaFiles);
                if (sources.length > 0){

                  self.player.load(sources[0].src);
                  self.tracker = new vast.tracker(ad, linearCreative);
                  self.tracker.on('clickthrough', function(url) {
                    // Open the resolved clickThrough url
                    window.open(url);
                  });
                  self.setupEvents(true);
                  return;
                }
                //break;
              }
            }
          }
        }
        self.status = 4;
        self.player.load(self.config.media);
      })
    },
    events: {
      canplay: function() { this.tracker.load() },
      timeupdate: function() {
        if (!isNaN(this.player.audio.duration)){
          if (isNaN(this.tracker.assetDuration)) {
            this.tracker.assetDuration = this.player.audio.duration;
          }
          var currenttime = parseInt(this.player.audio.currentTime);
          if (currenttime < 8) {
            this.player.ui.adsLabelSkip.innerHTML = 'Saltar publicidad en ' + (8 - currenttime);
          } else {
            this.player.ui.adsLabelSkip.classList.add('ca-ads-link');
            this.player.ui.adsLabelSkip.innerHTML = 'Omitir publicidad »';
          }

          this.tracker.setProgress(this.player.audio.currentTime);
          //this.player.ui.LabelTimeTotal.innerText = formatSec(this.player.audio.duration);
          this.player.ui.LabelTimeTotal.innerText = formatSec(this.player.audio.duration - this.player.audio.currentTime);
        }
      },
      play: function() {
        var self = this;
        this.player.setTitle(this.xml.ad.title, function() { self.tracker.click()} );
        if (!this.played) {
          self.status = 2;
          this.played = true;
          this.player.ui.wrap.classList.add('ca-ads');
        }
        this.tracker.setPaused(false);
      },
      pause: function() {
        this.player.setTitle(this.xml.ad.title, function() { self.tracker.click()}, true );
        this.tracker.setPaused(true)
      },
      ended: function() {
        this.tracker.complete(true);
        this.player.setTitle(this.config.title, null);
        this.status = 3;
        this.setupEvents(false);
        this.player.load(this.config.media);
        this.player.ui.wrap.classList.remove('ca-ads');
        this.player.play();
      },
      skipAds: function(event) {
        if(event.target.classList.contains('ca-ads-link')) {
          this.player.audio.currentTime = 0;
          this.player.audio.pause();
          this.tracker.skip();
          this.player.setTitle(this.config.title, null);
          this.status = 3;
          this.setupEvents(false);
          this.player.load(this.config.media);
          this.player.ui.wrap.classList.remove('ca-ads');
          this.player.play();
        }
      }
    },

    setupEvents: function(set) {
      if (!this.listeners) {
        this.listeners = {
          canplay: this.events.canplay.bind(this),
          timeupdate: this.events.timeupdate.bind(this),
          play: this.events.play.bind(this),
          pause: this.events.pause.bind(this),
          ended: this.events.ended.bind(this),
          skipAds: this.events.skipAds.bind(this),
        }
      }
      var audio = this.player.audio;
      if (set) {
        audio.addEventListener('canplay', this.listeners.canplay, false);
        audio.addEventListener('timeupdate', this.listeners.timeupdate, false);
        audio.addEventListener('play', this.listeners.play, false);
        audio.addEventListener('pause', this.listeners.pause, false);
        audio.addEventListener('ended', this.listeners.ended, false);
        this.player.ui.adsLabelSkip.addEventListener('click', this.listeners.skipAds, false);
      } else {
        audio.removeEventListener('canplay', this.listeners.canplay);
        audio.removeEventListener('timeupdate', this.listeners.timeupdate);
        audio.removeEventListener('play', this.listeners.play);
        audio.removeEventListener('pause', this.listeners.pause);
        audio.removeEventListener('ended', this.listeners.ended);
        this.player.ui.adsLabelSkip.removeEventListener('click', this.listeners.skipAds, false);
      }
    },
    createSourceObjects: function(media_files) {
      var fileURLs = {};
      var vidFormats = ['video/mp4', 'video/webm', 'video/ogv'];
      // get a list of files with unique formats
      for (var i = 0; i < media_files.length; i++) {
        var file_url = media_files[i].fileURL;
        var mime_type = media_files[i].mimeType;

        if (vidFormats.indexOf(mime_type) >= 0) {
          if(fileURLs[mime_type] === undefined) {
            fileURLs[mime_type] = file_url;
          }
        }
      };

      var sources = [];
      for (var j=0; j < vidFormats.length; j++) {
        var format = vidFormats[j];
        if (fileURLs[format] !== undefined) {
          sources.push({
            type: format,
            src: fileURLs[format]
          });
        }
      }
      return sources;
    }
  };
  return AudioPlayer
});


var audioWRPP = audioWRPP || {};
audioWRPP.cAudios = [];
audioWRPP.exec = function(fn){
	if(typeof fn !== 'function') return;
	var audio = fn();
	audioWRPP.cAudios.push(audio);
}

audioWRPP.init = function(){
	for (var i = 0; i < audioWRPP.send.length; i++) {
		audioWRPP.exec(audioWRPP.send[i]);
	}
  audioWRPP.send = {};
  audioWRPP.send.push= function(f){
  	audioWRPP.exec(f);
  }


  swSpa.beforemount.push({
  	fn: function(){
			for (var i = 0; i < audioWRPP.cAudios.length; i++) {
				audioWRPP.cAudios[i].destroy();
			}
			audioWRPP.cAudios = [];
		}
	});

}
audioWRPP.init();


/*swSpa.beforemount.push(function(){
	console.log("troyeddd");
	for (var i = 0; i < audioWRPP.cAudios.length; i++) {
	audioWRPP.cAudios[i].destroy();	}
	audioWRPP.cAudios = [];
});*/

/*

if(audioHandler){
	for (var i = 0; i < audioHandler.length; i++) {
		var audioCa = new AudioPlayer(audioHandler[i]);
	}
}*/