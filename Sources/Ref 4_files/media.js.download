function sendAG(hash, even, message) {
  var url = trackJS.src;
  res = url.split("\/?");
  var img = document.createElement("img");
  url = nhost + 'video/?' + res[1] + '&even=' + even + '&hash=' + hash + ((message !== undefined) ? '&message=' + message : '');
  img.src = url;
  document.body.appendChild(img);
}

function utf8_to_b64(str) {
  return window.btoa(unescape(encodeURIComponent(str)));
}

function b64_to_utf8(str) {
  return decodeURIComponent(escape(window.atob(str)));
}

function setJW7(player_id, video_source, video_img, playlist, hash, rtag, autoplay, section, vtemas, sratio, ancho) {
  var youregexp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/i;
  var videoID = video_source.match(youregexp);  

  if (videoID) {
    rtag = null;
    var content = document.getElementById(player_id);
    $(content).parent().removeClass('wait-player'); 
  }

    window["t25per_" + player_id] = false;
    window["t50per_" + player_id] = false;
    window["t75per_" + player_id] = false;
    window["t100per_" + player_id] = false;
    window["vplay_" + player_id] = false;

    if (!sratio) {
      sratio = "16:9";
    }

    if (!ancho) {
      ancho = "100%";
    }

    if (!autoplay) {
      autoplay = false;
    }

    var sup = {
      androidhls:'true',
      hlshtml:'true',
      primary: 'html5',
      controlbar: 'bottom',
      autostart: autoplay,
      skin: {
        name: "bekle"
      },
      width: ancho,
      aspectratio: sratio,
      image: video_img,
      abouttext: "RPP",
      aboutlink: "http://rpp.pe",
      ga: {}
    }

    if(rtag !== "null" && rtag !== null){

      if(section!= null || vtemas != null){
          rtag = rtag + "&cust_params=";

          if(section!= null){
              rtag = rtag + "category%3D" + section;
          }

          if(vtemas != null) {
              rtag = rtag + "%26vtemas%3D" + vtemas.replace(/\|/g,'%2C');
          }
      }      


      sup['advertising'] =  {
        client: 'googima',
        skipoffset: 10,
        admessage: "Publicidad finaliza en xx segundos",
        skipmessage: "Saltar Anuncio en xx",
        tag: rtag
      }

    }


    if ("null" === playlist || undefined === playlist || "[]" === playlist || '"[]"' === playlist) {
      sup['file'] = video_source;
    } else {
      playlist = JSON.parse(playlist);
      source = [];
      for (i in playlist) {
        if (typeof playlist[i] === 'object') {
          source.push({
            'label': 'file',
            'file': playlist[i].file
          });
        } else {
          source.push({
            'label': i,
            'file': playlist[i]
          });
        }
      }
      source.push({
        'label': '420p',
        'file': video_source
      });
      source[1]['default'] = "true";
      sup['sources'] = source;
    }

    var setJw = function(){
      if(typeof jwplayer === 'function'){
        var pI = jwplayer(player_id).setup(sup);
        pI.on('ready', function () {
          trackingJW7(pI, hash, player_id);
        });
      }else setTimeout(setJw,50);      
    }
    setJw();

    //return  pI;  
}

function trackingJW7(pI, hash, player_id) {
  //sendAG(hash, 'played');
  vplay = false;
  var content = document.getElementById(player_id);

  if (xsl.dv.canTouch) {
    pI.on('playlist', function (obje) {
      console.log("playlist");    
      $(content).parent().removeClass('wait-player');
    });
  }

  //Play
  pI.on('adPlay play', function (obje) {
    $(content).parent().removeClass('wait-player');
  }).on('play', function (obje) {    
    $(content).parent().removeClass('wait-player');
    if (window["t100per_" + player_id] && !vplay) {
      sendAG(hash, "replay");
      vplay = true;
    } else if (obje.oldstate === 'paused' && vplay && !window["t100per_" + player_id]) {
      sendAG(hash, "resume");
    } else if (obje.oldstate === 'buffering' && vplay && !window["t100per_" + player_id]) {
      sendAG(hash, "lag");
    } else {
      sendAG(hash, 'play');
      vplay = true;
    }
    setInterval(function () {
      calcProgre(pI, hash, player_id)
    }, 1000);
    if(typeof cscore === 'object') cscore.time = true;
  }).on('complete', function () {
    sendAG(hash, '100_repro');
    window["t100per_" + player_id] = true;
    vplay = false;
    if(typeof cscore === 'object') cscore.time = false;
  }).on('pause', function (obje) {
    sendAG(hash, "pause");
    if(typeof cscore === 'object') cscore.time = false;
  }).on('setupError', function (obje) {
    sendAG(hash, "setuperror");
  }).on('adClick', function (obje) {
    sendAG(hash, "adclick", utf8_to_b64(obje['tag']));
  }).on('adComplete', function (obje) {
    sendAG(hash, "adcomplete", utf8_to_b64(obje['tag']));
  }).on('adSkipped', function (obje) {
    sendAG(hash, "adskipped", utf8_to_b64(obje['tag']));
  }).on('adError', function (otag) {}).on('adRequest', function (tag, adposition) {}).on('adImpression', function (obje) {
    sendAG(hash, "adimpression", utf8_to_b64(obje['tag']));
  }).on('adPlay', function (obje) {
    sendAG(hash, "adplay", utf8_to_b64(obje['tag']));
  }).on('levels', function (obje) {
    sendAG(hash, "levels", obje['levels'][obje['currentQuality']]['label']);
  }).on('levelsChanged', function (obje) {
    sendAG(hash, "levelsChanged", obje['levels'][obje['currentQuality']]['label']);
  }).on('bufferChange', function (obje) {
    if (obje.bufferPercent === 100) {
      sendAG(hash, "buffer_completo");
    }
  }).on('error', function (obje) {
    sendAG(hash, 'error play', obje.message);
  });


}

function calcProgre(pI, hash, player_id) {
  var duration = pI.getDuration();
  var position = pI.getPosition();
  if (duration > 0 && position > 0) {
    var t25 = duration * 0.25;
    var t50 = duration * 0.50;
    var t75 = duration * 0.75;

    if (position > t75 && !window["t75per_" + player_id]) {
      window["t25per_" + player_id] = true;
      window["t50per_" + player_id] = true;
      window["t75per_" + player_id] = true;
      sendAG(hash, "75_repro");
    } else if (position > t50 && !window["t50per_" + player_id]) {
      window["t25per_" + player_id] = true;
      window["t50per_" + player_id] = true;
      sendAG(hash, "50_repro");
    } else if (position > t25 && !window["t25per_" + player_id]) {
      window["t25per_" + player_id] = true;
      sendAG(hash, "25_repro");
    }
  }
}



var script = document.createElement("script");
script.type = "text/javascript";
script.async = true;
//script.src = "http://p.jwpcdn.com/player/v/7.6.0/jwplayer.js";
script.src = "https://ssl.p.jwpcdn.com/player/v/7.12.8/jwplayer.js";
script.addEventListener("load", function () {
  jwplayer.key = "L/ARBHy5b4pG1YAD0ou40gMzoAVHnOcJetOEvw==";
});

document.getElementsByTagName("head")[0].appendChild(script);
var $media = $('.x-media');
var mobile = navigator.userAgent.match(/tablet|iPad|playbook|iPhone|android|iPod/i);


if(!mobile){

  $('.x-media').on(xsl.dv.clickTap + '.xmedia', function (event) {
    event.preventDefault();
    var $this = $(this);
    var par = $this.data('x'),
    idPlayer = 'jwplayer-' + Math.random().toString().substring(2);
    var $fig = $this.closest('figure');
    var text = $fig.hasClass('holder') ? $fig.siblings('.cont').text() : $fig.children('figcaption').text() ;
    if (text){
      $this.parent().append('<div class="pre-sumary"><div class="inside"><small>Cargando media...</small> <br/>' + text + '</div></div>');
      $this.parent().find('.pre-sumary').css('color');
    }
    $this.parent().addClass('here-player wait-player');
    $this.before('<div id="' + idPlayer + '" class="jwplayer"></div>');
    
    setJW7(idPlayer, par.video_source, par.video_img, par.playlist, par.hash, par.rtag, true, par.section, par.vtemas);

  });

}else{
  $media.each(function(){
    var $this = $(this);
    var par = $this.data('x'),
    idPlayer = 'jwplayer-' + Math.random().toString().substring(2);
    $this.parent().addClass('here-player');
    $this.before('<div id="' + idPlayer + '" class="jwplayer"></div>');
    setJW7(idPlayer, par.video_source, par.video_img, par.playlist, par.hash, par.rtag, true, par.section, par.vtemas);

  });
}
